This code is primarily based on Lindegren et al.(2021)